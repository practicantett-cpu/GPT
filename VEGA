{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "description": "Tabla con Family Type como botones (filtro interno). Fondo transparente.",
  "background": "transparent",
  "autosize": { "type": "pad", "contains": "padding" },
  "padding": { "left": 0, "right": 0, "top": 10, "bottom": 10 },

  "signals": [
    { "name": "width",  "update": "pbiContainerWidth" },
    { "name": "height", "update": "pbiContainerHeight" },

    { "name": "headerH",      "value": 112 },
    { "name": "tableHeaderH", "value": 44 },
    { "name": "rowH",         "value": 72 },
    { "name": "yPadInner",    "value": 0.20 },

    /* columnas */
    { "name": "poX",       "value": 7 },
    { "name": "itemX",     "value": 105 },
    { "name": "descX",     "value": 195 },
    { "name": "progLeft",  "update": "width * 0.4" },
    { "name": "progRight", "update": "width * 0.62" },
    { "name": "pctTextX",  "update": "width * 0.65" },
    { "name": "reqX",      "update": "width * 0.74" },
    { "name": "execX",     "update": "width * 0.86" },
    { "name": "manufX",    "update": "width * 0.96" },

    { "name": "tableBodyH", "update": "max(height - headerH - tableHeaderH, 0)" },
    { "name": "progressBarThickness", "value": 15 },
    { "name": "ftGap", "value": 10 },
    {
      "name": "ftCardWidth",
      "update": "max(length(data('families')),1) ? max(width - max(length(data('families')) - 1, 0) * ftGap, 0) / max(length(data('families')), 1) : width"
    },
    { "name": "donutOuterRadius", "update": "min(ftCardWidth, headerH) * 0.28" },
    { "name": "donutInnerRadius", "update": "max(donutOuterRadius - progressBarThickness / 2, 0)" },
    { "name": "donutCenterXOffset", "update": "min(donutOuterRadius + 12, ftCardWidth / 2)" },
    { "name": "donutCenterY", "update": "headerH / 2" },
    { "name": "labelGap", "value": 12 },
    {
      "name": "tableScroll",
      "value": 0,
      "on": [
        {
          "events": { "type": "wheel", "markname": "tableBody", "consume": true },
          "update": "clamp(tableScroll + event.deltaY, 0, max(0, data('rows').length * rowH - tableBodyH))"
        },
        {
          "events": { "signal": "selectedFT" },
          "update": "0"
        },
        {
          "events": { "signal": "tableBodyH" },
          "update": "clamp(tableScroll, 0, max(0, data('rows').length * rowH - tableBodyH))"
        },
        {
          "events": [ { "source": "view", "type": "data", "name": "rows" } ],
          "update": "clamp(tableScroll, 0, max(0, data('rows').length * rowH - tableBodyH))"
        }
      ]
    },

    /* selección de Family Type (click para seleccionar / deseleccionar) */
    {
      "name": "selectedFT",
      "value": null,
      "on": [
        { "events": "@ftCard:click", "update": "selectedFT===datum.FamilyType ? null : datum.FamilyType" }
      ]
    }
  ],

  "data": [
    { "name": "dataset" },

    /* filas (tabla) */
    {
      "name": "rows",
      "source": "dataset",
      "transform": [
        { "type": "formula", "as": "FamilyType", "expr": "datum['Family Type']" },
        { "type": "formula", "as": "AvancePct",  "expr": "datum['Porcentaje Avance'] * 100" },
        { "type": "formula", "as": "AvanceText", "expr": "format(datum['Porcentaje Avance'] * 100, '.0f') + '%'" },
        { "type": "formula", "as": "ColorBar",   "expr": "datum['Porcentaje Avance']*100 < 30 ? '#e74c3c' : datum['Porcentaje Avance']*100 < 60 ? '#f39c12' : datum['Porcentaje Avance']*100 < 90 ? '#00b3b3' : '#2c3e50'" },
        { "type": "formula", "as": "FechaFmt",   "expr": "timeFormat(toDate(datum['Compromise date']), '%d-%b-%Y')" },
        { "type": "formula", "as": "ManufacturingText", "expr": "'Manufacturing Date: ' + datum.FechaFmt" },
        { "type": "collect", "sort": { "field": ["PO", "Item"], "order": ["ascending", "ascending"] } },
        { "type": "window",  "ops": ["row_number"], "as": ["RowID"] },
        { "type": "filter",  "expr": "selectedFT==null || datum.FamilyType==selectedFT" }
      ]
    },

    /* cards (siempre muestran todas las familias disponibles en el dataset del contexto) */
    {
      "name": "families",
      "source": "dataset",
      "transform": [
        { "type": "formula", "as": "FamilyType", "expr": "datum['Family Type']" },
        { "type": "formula", "as": "CompromiseDateValue", "expr": "toDate(datum['Compromise date'])" },
        {
          "type": "aggregate",
          "groupby": ["FamilyType"],
          "ops": ["max", "mean"],
          "fields": ["CompromiseDateValue", "Porcentaje Avance"],
          "as": ["CompromiseDateValue", "MeanAvance"]
        },
        { "type": "collect", "sort": { "field": ["FamilyType"], "order": ["ascending"] } },
        { "type": "window", "ops": ["row_number"], "as": ["FamilyRank"] },
        { "type": "formula", "as": "FamilyIndex", "expr": "datum.FamilyRank - 1" },
        {
          "type": "formula",
          "as": "CompromiseDateText",
          "expr": "isValid(datum.CompromiseDateValue) ? timeFormat(datum.CompromiseDateValue, '%d-%b-%Y') : ''"
        },
        {
          "type": "formula",
          "as": "ProgressFraction",
          "expr": "isValid(datum.MeanAvance) ? clamp(datum.MeanAvance, 0, 1) : 0"
        },
        {
          "type": "formula",
          "as": "ProgressPctText",
          "expr": "format(datum.ProgressFraction * 100, '.0f') + '%'"
        },
        {
          "type": "formula",
          "as": "ProgressColor",
          "expr": "datum.ProgressFraction*100 < 30 ? '#e74c3c' : datum.ProgressFraction*100 < 60 ? '#f39c12' : datum.ProgressFraction*100 < 90 ? '#00b3b3' : '#2c3e50'"
        }
      ]
    }
  ],

  "scales": [
    { "name": "y",    "type": "band", "domain": { "data": "rows", "field": "RowID" }, "range": { "step": { "signal": "rowH" } }, "paddingInner": { "signal": "yPadInner" } },
    { "name": "prog", "type": "linear", "domain": [0, 100], "range": { "signal": "[progLeft, progRight]" } }
  ],

  "marks": [
    /* ───── FAMILY TYPE: cards/botones ───── */
    {
      "type": "group",
      "name": "familyHeader",
      "interactive": true,
      "encode": { "update": { "x": { "value": 0 }, "y": { "value": 0 }, "width": { "signal": "width" }, "height": { "signal": "headerH" } } },
      "marks": [
        {
          "type": "group",
          "name": "ftCardGroup",
          "from": { "data": "families" },
          "encode": {
            "update": {
              "x": { "signal": "datum.FamilyIndex * (ftCardWidth + ftGap)" },
              "y": { "value": 0 },
              "width": { "signal": "ftCardWidth" },
              "height": { "signal": "headerH" }
            }
          },
          "marks": [
            {
              "type": "rect",
              "name": "ftCard",
              "encode": {
                "update": {
                  "x": { "value": 0 },
                  "y": { "value": 0 },
                  "width": { "signal": "ftCardWidth" },
                  "height": { "signal": "headerH" },
                  "fill": [
                    { "test": "selectedFT && datum.FamilyType===selectedFT", "value": "white" },
                    { "value": "#E6E6E6" }
                  ],
                  "stroke": { "value": "transparent" },
                  "strokeWidth": { "value": 0 },
                  "cursor": { "value": "pointer" },
                  "cornerRadiusTopLeft":     { "value": 0 },
                  "cornerRadiusTopRight":    { "value": 14 },
                  "cornerRadiusBottomLeft":  { "value": 0 },
                  "cornerRadiusBottomRight": { "value": 0 }
                },
                "hover": {
                  "fillOpacity": { "value": 0.9 }
                }
              }
            },
            {
              "type": "arc",
              "encode": {
                "update": {
                  "x": { "signal": "donutCenterXOffset" },
                  "y": { "signal": "donutCenterY" },
                  "startAngle": { "value": 0 },
                  "endAngle": { "value": 6.28318 },
                  "innerRadius": { "signal": "donutInnerRadius" },
                  "outerRadius": { "signal": "donutOuterRadius" },
                  "fill": { "value": "#d9d9d9" },
                  "pointerEvents": { "value": "none" }
                }
              }
            },
            {
              "type": "arc",
              "encode": {
                "update": {
                  "x": { "signal": "donutCenterXOffset" },
                  "y": { "signal": "donutCenterY" },
                  "startAngle": { "value": 0 },
                  "endAngle": { "signal": "6.28318 * datum.ProgressFraction" },
                  "innerRadius": { "signal": "donutInnerRadius" },
                  "outerRadius": { "signal": "donutOuterRadius" },
                  "fill": { "field": "ProgressColor" },
                  "pointerEvents": { "value": "none" }
                }
              }
            },
            {
              "type": "text",
              "encode": {
                "update": {
                  "x": { "signal": "donutCenterXOffset" },
                  "y": { "signal": "donutCenterY" },
                  "text": { "field": "ProgressPctText" },
                  "font": { "value": "Segoe UI" },
                  "fontSize": { "value": 14 },
                  "fontWeight": { "value": "bold" },
                  "align": { "value": "center" },
                  "baseline": { "value": "middle" },
                  "fill": { "value": "#333" },
                  "pointerEvents": { "value": "none" }
                }
              }
            },
            {
              "type": "text",
              "encode": {
                "update": {
                  "x": {
                    "signal": "ftCardWidth < 120 ? ftCardWidth / 2 : min(donutCenterXOffset + donutOuterRadius + 16, ftCardWidth - 12)"
                  },
                  "y": {
                    "signal": "headerH/2 - labelGap/2"
                  },
                  "text": { "field": "FamilyType" },
                  "font": { "value": "Segoe UI" },
                  "fontSize": { "value": 18 },
                  "fontWeight": { "value": "bold" },
                  "align": {
                    "signal": "ftCardWidth < 120 ? 'center' : 'left'"
                  },
                  "baseline": { "value": "bottom" },
                  "fill": { "value": "#333" },
                  "pointerEvents": { "value": "none" },
                  "limit": {
                    "signal": "ftCardWidth < 120 ? max(ftCardWidth - 24, 0) : max(ftCardWidth - max(donutCenterXOffset + donutOuterRadius + 16, 12) - 16, 0)"
                  }
                }
              }
            },
            {
              "type": "text",
              "encode": {
                "update": {
                  "x": {
                    "signal": "ftCardWidth < 120 ? ftCardWidth / 2 : min(donutCenterXOffset + donutOuterRadius + 16, ftCardWidth - 12)"
                  },
                  "y": {
                    "signal": "headerH/2 + labelGap/2"
                  },
                  "text": { "field": "CompromiseDateText" },
                  "font": { "value": "Segoe UI" },
                  "fontSize": { "value": 13 },
                  "align": {
                    "signal": "ftCardWidth < 120 ? 'center' : 'left'"
                  },
                  "baseline": { "value": "top" },
                  "fill": { "value": "#555" },
                  "pointerEvents": { "value": "none" },
                  "limit": {
                    "signal": "ftCardWidth < 120 ? max(ftCardWidth - 24, 0) : max(ftCardWidth - max(donutCenterXOffset + donutOuterRadius + 16, 12) - 16, 0)"
                  }
                }
              }
            }
          ]
        }
      ]
    },

    /* ───── Encabezado de tabla ───── */
    {
      "type": "group",
      "name": "tableHeader",
      "interactive": false,
      "encode": { "update": { "x": { "value": 0 }, "y": { "signal": "headerH" }, "width": { "signal": "width" }, "height": { "signal": "tableHeaderH" } } },
      "marks": [
        {
          "type": "rect",
          "encode": {
            "update": {
              "x": { "value": 0 },
              "y": { "value": 0 },
              "width": { "signal": "width" },
              "height": { "signal": "tableHeaderH" },
              "fill": { "value": "#E6E6E6" }
            }
          }
        },
        { "type": "text", "encode": { "update": { "x": { "signal": "poX" },   "y": { "signal": "tableHeaderH/2" }, "baseline": { "value": "middle" }, "font": { "value": "Segoe UI" }, "fontSize": { "value": 18 }, "fontWeight": { "value": "bold" }, "fill": { "value": "#555" }, "text": { "value": "PO" }, "align": { "value": "left" } } } },
        { "type": "text", "encode": { "update": { "x": { "signal": "itemX + 20" }, "y": { "signal": "tableHeaderH/2" }, "align": { "value": "center" }, "baseline": { "value": "middle" }, "font": { "value": "Segoe UI" }, "fontSize": { "value": 18 }, "fontWeight": { "value": "bold" }, "fill": { "value": "#555" }, "text": { "value": "Item" } } } },
        { "type": "text", "encode": { "update": { "x": { "signal": "descX" }, "y": { "signal": "tableHeaderH/2" }, "baseline": { "value": "middle" }, "font": { "value": "Segoe UI" }, "fontSize": { "value": 18 }, "fontWeight": { "value": "bold" }, "fill": { "value": "#555" }, "text": { "value": "Product desc" }, "align": { "value": "left" } } } },
        { "type": "text", "encode": { "update": { "x": { "signal": "(progLeft + progRight)/2" }, "y": { "signal": "tableHeaderH/2" }, "align": { "value": "center" }, "baseline": { "value": "middle" }, "font": { "value": "Segoe UI" }, "fontSize": { "value": 18 }, "fontWeight": { "value": "bold" }, "fill": { "value": "#555" }, "text": { "value": "% Executed" } } } },
        { "type": "text", "encode": { "update": { "x": { "signal": "reqX" }, "y": { "signal": "tableHeaderH/2" }, "align": { "value": "center" }, "baseline": { "value": "middle" }, "font": { "value": "Segoe UI" }, "fontSize": { "value": 18 }, "fontWeight": { "value": "bold" }, "fill": { "value": "#555" }, "text": { "value": "Required Qty" } } } },
        { "type": "text", "encode": { "update": { "x": { "signal": "execX" }, "y": { "signal": "tableHeaderH/2" }, "align": { "value": "center" }, "baseline": { "value": "middle" }, "font": { "value": "Segoe UI" }, "fontSize": { "value": 18 }, "fontWeight": { "value": "bold" }, "fill": { "value": "#555" }, "text": { "value": "Executed Qty" } } } },
        { "type": "text", "encode": { "update": { "x": { "signal": "manufX" }, "y": { "signal": "tableHeaderH/2" }, "align": { "value": "center" }, "baseline": { "value": "middle" }, "font": { "value": "Segoe UI" }, "fontSize": { "value": 18 }, "fontWeight": { "value": "bold" }, "fill": { "value": "#555" }, "text": { "value": "Manufacturer" } } } }
      ]
    },

    /* ───── Cuerpo de tabla ───── */
    {
      "type": "group",
      "name": "tableBody",
      "clip": true,
      "encode": {
        "update": {
          "x": { "value": 0 },
          "y": { "signal": "headerH + tableHeaderH" },
          "width": { "signal": "width" },
          "height": { "signal": "tableBodyH" }
        }
      },
      "marks": [
        { "type": "rule", "from": { "data": "rows" }, "encode": { "update": { "x": { "value": 0 }, "x2": { "signal": "width" }, "y": { "signal": "scale('y', datum.RowID) - tableScroll + bandwidth('y')" }, "stroke": { "value": "#e0e0e0" }, "strokeWidth": { "value": 1 } } } },

        { "type": "text", "from": { "data": "rows" }, "encode": { "update": { "x": { "signal": "poX" }, "y": { "signal": "scale('y', datum.RowID) - tableScroll + bandwidth('y')/2" }, "baseline": { "value": "middle" }, "align": { "value": "left" }, "font": { "value": "Segoe UI" }, "fontSize": { "value": 17 }, "fill": { "value": "#333" }, "text": { "field": "PO" } } } },
        { "type": "text", "from": { "data": "rows" }, "encode": { "update": { "x": { "signal": "itemX" }, "y": { "signal": "scale('y', datum.RowID) - tableScroll + bandwidth('y')/2" }, "baseline": { "value": "middle" }, "align": { "value": "left" }, "font": { "value": "Segoe UI" }, "fontSize": { "value": 17 }, "fill": { "value": "#333" }, "text": { "field": "Item" } } } },

        { "type": "text", "from": { "data": "rows" }, "encode": { "update": { "x": { "signal": "descX" }, "y": { "signal": "scale('y', datum.RowID) - tableScroll + bandwidth('y')/2 - 8" }, "baseline": { "value": "middle" }, "align": { "value": "left" }, "font": { "value": "Segoe UI" }, "fontSize": { "value": 17 }, "fill": { "value": "#333" }, "text": { "signal": "datum['Product desc']" } } } },
        { "type": "text", "from": { "data": "rows" }, "encode": { "update": { "x": { "signal": "descX" }, "y": { "signal": "scale('y', datum.RowID) - tableScroll + bandwidth('y')/2 + 12" }, "baseline": { "value": "top" }, "align": { "value": "left" }, "font": { "value": "Segoe UI" }, "fontSize": { "value": 13 }, "fill": { "value": "#888" }, "text": { "field": "ManufacturingText" } } } },

        { "type": "rect", "from": { "data": "rows" }, "encode": { "update": { "x": { "signal": "progLeft" }, "x2": { "signal": "progRight" }, "y": { "signal": "scale('y', datum.RowID) - tableScroll + bandwidth('y')/2 - progressBarThickness/2" }, "height": { "signal": "progressBarThickness" }, "fill": { "value": "#e6e6e6" }, "cornerRadius": { "value": 8 } } } },
        {
          "type": "rect",
          "from": { "data": "rows" },
          "encode": {
            "update": {
              "x": { "signal": "progLeft" },
              "x2": { "scale": "prog", "field": "AvancePct" },
              "y": { "signal": "scale('y', datum.RowID) - tableScroll + bandwidth('y')/2 - progressBarThickness/2" },
              "height": { "signal": "progressBarThickness" },
              "fill": { "field": "ColorBar" },
              "cornerRadiusTopLeft": { "value": 8 },
              "cornerRadiusTopRight": { "value": 8 },
              "cornerRadiusBottomLeft": { "value": 8 },
              "cornerRadiusBottomRight": { "value": 8 }
            }
          }
        },
        { "type": "text", "from": { "data": "rows" }, "encode": { "update": { "x": { "signal": "pctTextX" }, "y": { "signal": "scale('y', datum.RowID) - tableScroll + bandwidth('y')/2" }, "baseline": { "value": "middle" }, "align": { "value": "left" }, "font": { "value": "Segoe UI" }, "fontSize": { "value": 15 }, "fontWeight": { "value": "bold" }, "fill": { "value": "#333" }, "text": { "field": "AvanceText" } } } },

        { "type": "text", "from": { "data": "rows" }, "encode": { "update": { "x": { "signal": "reqX" }, "y": { "signal": "scale('y', datum.RowID) - tableScroll + bandwidth('y')/2" }, "baseline": { "value": "middle" }, "align": { "value": "center" }, "font": { "value": "Segoe UI" }, "fontSize": { "value": 17 }, "fill": { "value": "#333" }, "text": { "signal": "isValid(datum['Nominal Qty']) ? format(datum['Nominal Qty'], '.0f') : ''" } } } },
        { "type": "text", "from": { "data": "rows" }, "encode": { "update": { "x": { "signal": "execX" }, "y": { "signal": "scale('y', datum.RowID) - tableScroll + bandwidth('y')/2" }, "baseline": { "value": "middle" }, "align": { "value": "center" }, "font": { "value": "Segoe UI" }, "fontSize": { "value": 17 }, "fill": { "value": "#333" }, "text": { "signal": "isValid(datum['Executed Qty']) ? format(datum['Executed Qty'], '.0f') : ''" } } } },
        { "type": "text", "from": { "data": "rows" }, "encode": { "update": { "x": { "signal": "manufX" }, "y": { "signal": "scale('y', datum.RowID) - tableScroll + bandwidth('y')/2" }, "baseline": { "value": "middle" }, "align": { "value": "center" }, "font": { "value": "Segoe UI" }, "fontSize": { "value": 17 }, "fill": { "value": "#333" }, "text": { "field": "Manufacturer" } } } }
      ]
    }
  ],

  "config": {
    "view": { "stroke": "transparent", "fill": "transparent" },
    "font": "Segoe UI",
    "axis": { "labelFont": "Segoe UI", "titleFont": "Segoe UI" },
    "style": { "cell": { "stroke": "transparent" } }
  }
}
